= Services
Eitan Suez <esuez@pivotal.io>
v0.1, 2017:  GCP-specific Lab Instructions
:doctype: book
:linkcss:
:docinfo: shared
:toc: left
:sectnums:
:linkattrs:
:icons: font
:source-highlighter: highlightjs
:imagesdir: docimages

_Estimated Time: 25 minutes_

== Requirements

link:requirements{outfilesuffix}[Lab Requirements]

== What you will learn

* How to create a managed service instance
* How to create a user-provided service instance
* How to bind an application to a service instance


== Exercises

=== Review `articulate` dependencies

`articulate` exposes functionality to add attendees on the _Services_ page.  However, `articulate` doesn't do this alone.  It makes REST calls to the `attendee-service` application. To learn more about services, let's provision the `attendee-service` application.

[.thumb]
image::services.png[Services]


=== Push the `attendee-service` application

. link:artifacts/attendee-service-0.0.1-SNAPSHOT.jar[Download] the `attendee-service` application.  Copy the file to folder: `~/pivotal-cloud-foundry-developer-workshop/attendee-service/` (`~` is shorthand for the home directory in Linux, Mac and Unix based operating systems).  You will need to create this directory in your https://en.wikipedia.org/wiki/Home_directory[home^] directory.

NOTE: If your browser warns you about downloading this file please proceed to download it.

https://github.com/pivotal-enablement/attendee-service[Source^] is not required, but you may be curious how it works as you move through the labs.

. Push the `attendee-service` application.

[source,bash,subs="attributes+"]
----
$ cd ~/pivotal-cloud-foundry-developer-workshop/attendee-service/
$ cf push attendee-service -p ./attendee-service-0.0.1-SNAPSHOT.jar -m 512M --random-route
----

Does `attendee-service` start up correctly?  Why not?

=== Add a Managed Service

. Review the http://docs.pivotal.io/pivotalcf/devguide/services/managing-services.html[documentation^] on managing service instances
. Review what services are available in the marketplace.
+
[source,bash,subs="attributes+"]
----
$ cf marketplace
----

. Provision a MySql service instance.
+
[alternatives#create_service]
Pivotal Cloud Foundry | Pivotal Web Services
+
[#tabs-create_service-1.create_service]
--
[source,bash,subs="attributes+"]
----
$ cf create-service p-mysql 100mb-dev attendee-mysql
----
--
+
[#tabs-create_service-2.create_service]
--
[source,bash,subs="attributes+"]
----
$ cf create-service cleardb spark attendee-mysql
----
--

. Now we need to bind the application with the service instance.
+
[source,bash,subs="attributes+"]
----
$ cf bind-service attendee-service attendee-mysql
----
+
NOTE: You can ignore the _TIP: Use 'cf restage attendee-service' to ensure your env variable changes take effect_ message at this time.

. Restart the application.
+
[source,bash,subs="attributes+"]
----
$ cf restart attendee-service
----

. View the `attendee-service` in a browser.
+
You should see response similar to the following (pic is using the https://chrome.google.com/webstore/detail/json-formatter/bcjindcccaagfpapjjmafapmmgkkhgoa?hl=en[JSON Formatter for Chrome^]):
+
[.thumb]
image::attendee_service.png[attendee-service]

.How does this work?
****
. Read about how twelve-factor apps handle http://12factor.net/backing-services[backing services^] and http://12factor.net/config[configuration^]>.
. Read about https://docs.pivotal.io/pivotalcf/devguide/deploy-apps/environment-variable.html#VCAP-SERVICES[VCAP_SERVICES^].
. View the environment for `attendee-service`.
+
[source,bash,subs="attributes+"]
----
$ cf env attendee-service
----
. Different languages/frameworks will have various ways to read environment variables.  `attendee-service` takes advantage of a https://github.com/cloudfoundry/java-buildpack[Java Buildpack^] feature called https://github.com/cloudfoundry/java-buildpack-auto-reconfiguration[Auto-Reconfiguration^] that will automatically re-write bean definitions to connect with services bound to an application.
****


==== Questions

* After binding a service to an application why is the application restarted/restaged?
* In this case, why could we `restart` vs `restage`?


=== Add a User-Provided Service Instance

In the enterprise, not all services will be provisioned by Pivotal Cloud Foundry.

For example, consider your Oracle RAC cluster.  How can we connect our applications running on Pivotal Cloud Foundry to these external systems?

Additionally, how can we easily connect applications together running on the platform?

`articulate's` default configuration for the `attendee-service` `uri` is `http://localhost:8181/attendees`.  The subsequent steps will allow you to override the default configuration with your own.

. Read about http://docs.pivotal.io/pivotalcf/devguide/services/user-provided.html[user-provided service instances^].

. Create a user-provided service instance.  This will create an interactive prompt.  Don't use the literal below for the value of `uri`, use your `attendee-service` `uri`.  Also make sure to specify `http` and include `/attendees` in the path.
+
CAUTION: This will not work with `https`.
+
[source,bash,subs="attributes+"]
----
$ cf create-user-provided-service attendee-service -p uri

uri> http://attendee-service-surfy-glt.pcfi1.fe.gopivotal.com/attendees
----

. Bind `articulate` to the `attendee-service` user-provided service.
+
[source,bash,subs="attributes+"]
----
$ cf bind-service articulate attendee-service
----
+
NOTE: You can ignore the _TIP: Use 'cf restage articulate' to ensure your env variable changes take effect_ message at this time.

. Restart the application.
+
[source,bash,subs="attributes+"]
----
$ cf restart articulate
----

. Refresh the `articulate` _Services_ page.  You can now see the `attendee-service` listed under `Services`.
+
[.thumb]
image::articulate_attendee.png[articulate attendee]

. Review the environment.
+
[source,bash,subs="attributes+"]
----
$ cf env articulate
----

. Add some attendees.
+
NOTE: If you can't add attendees, review the `articulate` logs and the user-provided service instance configuration.

==== Questions

* From an application perspective, are managed services instances different from user-provided service instances?

== Beyond the class

* Use https://github.com/cloudfoundry-samples/spring-music[Spring Music^] and a User Provided Service Instance to connect to a database (MySQL or Oracle) in your environment.
